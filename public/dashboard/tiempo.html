<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiempo y Asistencia - CamAssist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .status-working {
            background: #10b981;
        }

        .status-on_break {
            background: #f59e0b;
        }

        .status-offline {
            background: #6b7280;
        }

        .skeleton {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            background: #e5e7eb;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: .5;
            }
        }
    </style>
    <link rel="icon" href="LogosMarca/icon16.png" type="image/png">
</head>

<body class="bg-gray-50">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-gradient-to-b from-purple-700 to-pink-600 min-h-screen p-6 text-white fixed">
            <div class="flex items-center mb-8">
                <span class="text-2xl mr-2">ü§ñ</span>
                <h1 class="text-xl font-bold">CamAssist</h1>
            </div>

            <nav class="space-y-2">
                <a href="/dashboard/index.html"
                    class="flex items-center px-4 py-3 rounded-lg hover:bg-white/10 transition">
                    <span class="mr-3">üìä</span> Dashboard
                </a>
                <a href="/dashboard/modelos.html"
                    class="flex items-center px-4 py-3 rounded-lg hover:bg-white/10 transition">
                    <span class="mr-3">üë©‚Äçüíº</span> Modelos
                </a>
                <a href="/dashboard/tiempo.html"
                    class="flex items-center px-4 py-3 rounded-lg hover:bg-white/10 transition">
                    <span class="mr-3">‚è±Ô∏è</span> Tiempo
                </a>
                <a href="/dashboard/tiempo-config.html"
                    class="flex items-center px-4 py-3 rounded-lg hover:bg-white/10 transition">
                    <span class="mr-3">‚öôÔ∏è</span> Configurar Tiempo
                </a>
                <a href="/dashboard/extensiones.html"
                    class="flex items-center px-4 py-3 rounded-lg hover:bg-white/10 transition">
                    <span class="mr-3">üß©</span> Extensiones
                </a>
                <a href="/dashboard/facturacion.html"
                    class="flex items-center px-4 py-3 rounded-lg hover:bg-white/10 transition">
                    <span class="mr-3">üí≥</span> Facturaci√≥n
                </a>
            </nav>

            <div class="absolute bottom-6 left-6 right-6">
                <div class="mb-4 text-sm opacity-80">
                    <div class="text-white/60">Studio</div>
                    <div class="font-semibold" id="studioName">Cargando...</div>
                </div>
                <button onclick="logout()"
                    class="w-full flex items-center justify-center px-4 py-2 rounded-lg hover:bg-white/10 transition">
                    <span class="mr-2">üö™</span> Salir
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto ml-64">
            <div class="p-8">
                <!-- Header -->
                <div class="mb-8 flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">‚è∞ Tiempo y Asistencia</h1>
                        <p class="text-gray-600">Control de horas, ganancias y asistencia</p>
                    </div>
                    <div class="flex flex-col gap-4">
                        <!-- Fila 1: Ver d√≠a espec√≠fico -->
                        <div class="flex items-center gap-4">
                            <label class="text-sm text-gray-600">Ver d√≠a:</label>
                            <input type="date" id="selectedDate" class="px-4 py-2 border rounded-lg"
                                onchange="loadData()">
                            <button onclick="loadData()"
                                class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                                üîÑ Actualizar
                            </button>
                        </div>

                        <!-- Fila 2: Exportar reporte por rango -->
                        <div class="flex items-center gap-4 bg-white p-4 rounded-xl shadow-sm flex-wrap">
                            <span class="text-sm font-medium text-gray-700">üìä Reporte:</span>
                            <div class="flex items-center gap-2">
                                <label class="text-xs text-gray-500">Desde:</label>
                                <input type="date" id="fechaInicio" class="px-3 py-2 border rounded-lg text-sm">
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-xs text-gray-500">Hasta:</label>
                                <input type="date" id="fechaFin" class="px-3 py-2 border rounded-lg text-sm">
                            </div>
                            <button onclick="exportExcel()"
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                                üì• Excel
                            </button>
                            <div class="flex gap-2">
                                <button onclick="setRangoHoy()"
                                    class="px-3 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded-lg">Hoy</button>
                                <button onclick="setRangoSemana()"
                                    class="px-3 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded-lg">Semana</button>
                                <button onclick="setRangoQuincena()"
                                    class="px-3 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded-lg">Quincena</button>
                                <button onclick="setRangoMes()"
                                    class="px-3 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded-lg">Mes</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-8">
                    <div class="bg-white rounded-xl shadow-sm p-4 text-center">
                        <div class="text-3xl mb-1">üë•</div>
                        <div class="text-2xl font-bold text-gray-800" id="totalModels">-</div>
                        <div class="text-xs text-gray-500">Total</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-4 text-center">
                        <div class="text-3xl mb-1">üü¢</div>
                        <div class="text-2xl font-bold text-green-600" id="onlineCount">-</div>
                        <div class="text-xs text-gray-500">Online</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-4 text-center">
                        <div class="text-3xl mb-1">üü°</div>
                        <div class="text-2xl font-bold text-yellow-600" id="breakCount">-</div>
                        <div class="text-xs text-gray-500">En Break</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-4 text-center">
                        <div class="text-3xl mb-1">‚ö´</div>
                        <div class="text-2xl font-bold text-gray-600" id="offlineCount">-</div>
                        <div class="text-xs text-gray-500">Offline</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-4 text-center">
                        <div class="text-3xl mb-1">‚úÖ</div>
                        <div class="text-2xl font-bold text-green-600" id="cumpleCount">-</div>
                        <div class="text-xs text-gray-500">Cumplen</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-4 text-center">
                        <div class="text-3xl mb-1">üí∞</div>
                        <div class="text-2xl font-bold text-purple-600" id="totalEarnings">-</div>
                        <div class="text-xs text-gray-500">Ganancias</div>
                    </div>
                </div>

                <!-- Models Table -->
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-6 border-b">
                        <h2 class="text-xl font-semibold text-gray-800">üìã Detalle por Modelo</h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Modelo
                                    </th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Estado
                                    </th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">
                                        Entrada</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Salida
                                    </th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Tiempo
                                    </th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">
                                        Progreso</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Cumple
                                    </th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">
                                        Ganancias</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">
                                        Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="modelsTableBody" class="divide-y divide-gray-200">
                                <tr>
                                    <td colspan="9" class="px-6 py-8 text-center text-gray-500">
                                        <div class="skeleton h-8 w-full rounded mb-2"></div>
                                        <div class="skeleton h-8 w-full rounded mb-2"></div>
                                        <div class="skeleton h-8 w-full rounded"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Secci√≥n Balance de Horas -->
                <div class="bg-white rounded-xl shadow-sm p-6 mt-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold text-gray-800">üìä Balance de Horas (Mes actual)</h2>
                        <button onclick="loadBalance()" class="text-purple-600 hover:text-purple-800">
                            üîÑ Actualizar
                        </button>
                    </div>

                    <div id="balanceContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal para ingresar ganancias -->
    <div id="earningsModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4">üí∞ Ingresar Ganancias</h3>
            <p class="text-gray-600 mb-4">Modelo: <strong id="modalModelName">-</strong></p>

            <input type="hidden" id="modalModelId">

            <div id="platformInputs" class="space-y-4 mb-6">
                <!-- Se llena din√°micamente -->
            </div>

            <div class="flex gap-3">
                <button onclick="saveEarnings()"
                    class="flex-1 bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700">
                    üíæ Guardar
                </button>
                <button onclick="closeEarningsModal()"
                    class="flex-1 bg-gray-200 py-3 rounded-lg font-semibold hover:bg-gray-300">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para agregar nota -->
    <div id="noteModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4">üìù Agregar Nota</h3>
            <p class="text-gray-600 mb-4">Modelo: <strong id="noteModalModelName">-</strong></p>

            <input type="hidden" id="noteModalModelId">

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de nota</label>
                <select id="noteType" class="w-full px-4 py-2 border rounded-lg" onchange="toggleCustomName()">
                    <option value="permission">üìã Permiso</option>
                    <option value="absence">‚ùå Falta</option>
                    <option value="late">‚è∞ Lleg√≥ tarde</option>
                    <option value="left_early">üèÉ Sali√≥ temprano</option>
                    <option value="other">üìå Otro</option>
                </select>
            </div>

            <!-- Campo nombre custom (solo para "Otro") -->
            <div id="customNameContainer" class="mb-4 hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">Nombre de la nota</label>
                <input type="text" id="customName" class="w-full px-4 py-2 border rounded-lg"
                    placeholder="Ej: Viaje familiar, Cita m√©dica...">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Observaci√≥n (opcional)</label>
                <textarea id="noteText" class="w-full px-4 py-2 border rounded-lg" rows="2"
                    placeholder="Ej: Se fue temprano por emergencia"></textarea>
            </div>

            <!-- ¬øDebe reponer horas? -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" id="mustRecover" class="w-5 h-5 text-purple-600 rounded">
                    <div>
                        <span class="font-medium text-gray-700">¬øDebe reponer horas?</span>
                        <p class="text-xs text-gray-500">Si marca esta opci√≥n, las horas se sumar√°n como deuda</p>
                    </div>
                </label>
            </div>

            <div class="flex gap-3">
                <button onclick="saveNote()"
                    class="flex-1 bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700">
                    üíæ Guardar
                </button>
                <button onclick="closeNoteModal()"
                    class="flex-1 bg-gray-200 py-3 rounded-lg font-semibold hover:bg-gray-300">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
    <!-- Modal para editar tiempo -->
    <div id="editTimeModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4">‚úèÔ∏è Editar Registro de Tiempo</h3>
            <p class="text-gray-600 mb-2">Modelo: <strong id="editTimeModelName">-</strong></p>
            <p class="text-gray-600 mb-4">Fecha: <strong id="editTimeDate">-</strong></p>

            <input type="hidden" id="editTimeModelId">

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">üü¢ Entrada</label>
                    <input type="time" id="editCheckIn"
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">üî¥ Salida</label>
                    <input type="time" id="editCheckOut"
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">üìù Motivo del cambio</label>
                <input type="text" id="editTimeReason"
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                    placeholder="Ej: Olvid√≥ marcar salida">
            </div>

            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                <p class="text-sm text-yellow-700">
                    ‚ö†Ô∏è Esto reemplazar√° los registros existentes de este d√≠a para esta modelo.
                </p>
            </div>

            <div class="flex gap-3">
                <button onclick="saveTimeEdit()"
                    class="flex-1 bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700">
                    üíæ Guardar
                </button>
                <button onclick="deleteTimeEntry()"
                    class="px-4 py-3 bg-red-100 text-red-600 rounded-lg font-semibold hover:bg-red-200">
                    üóëÔ∏è
                </button>
                <button onclick="closeEditTimeModal()"
                    class="flex-1 bg-gray-200 py-3 rounded-lg font-semibold hover:bg-gray-300">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://camassist.vercel.app/api';

        // Auth check
        const studioId = localStorage.getItem('studio_id');
        const studioName = localStorage.getItem('studio_name');
        if (!studioId) {
            window.location.href = '/dashboard/login.html';
        }
        document.getElementById('studioName').textContent = studioName || 'Mi Studio';

        // Set default date to today
        const today = new Date().toLocaleDateString('en-CA');
        document.getElementById('selectedDate').value = today;

        let studioSettings = {};
        let modelsData = [];

        // Load data on start
        loadData();

        // Auto-refresh every 30 seconds
        setInterval(loadData, 30000);

        // Inicializar fechas de reporte
        initReportDates();

        function initReportDates() {
            const today = new Date().toLocaleDateString('en-CA');
            const firstOfMonth = new Date();
            firstOfMonth.setDate(1);
            document.getElementById('fechaInicio').value = firstOfMonth.toLocaleDateString('en-CA');
            document.getElementById('fechaFin').value = today;
        }

        function setRangoHoy() {
            const today = new Date().toLocaleDateString('en-CA');
            document.getElementById('fechaInicio').value = today;
            document.getElementById('fechaFin').value = today;
        }

        function setRangoSemana() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const monday = new Date(today);
            monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
            document.getElementById('fechaInicio').value = monday.toLocaleDateString('en-CA');
            document.getElementById('fechaFin').value = today.toLocaleDateString('en-CA');
        }

        function setRangoQuincena() {
            const today = new Date();
            const day = today.getDate();
            const year = today.getFullYear();
            const month = today.getMonth();
            let inicio, fin;
            if (day <= 15) {
                inicio = new Date(year, month, 1);
                fin = new Date(year, month, 15);
            } else {
                inicio = new Date(year, month, 16);
                fin = new Date(year, month + 1, 0);
            }
            document.getElementById('fechaInicio').value = inicio.toLocaleDateString('en-CA');
            document.getElementById('fechaFin').value = fin.toLocaleDateString('en-CA');
        }

        function setRangoMes() {
            const today = new Date();
            const firstOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            document.getElementById('fechaInicio').value = firstOfMonth.toLocaleDateString('en-CA');
            document.getElementById('fechaFin').value = lastOfMonth.toLocaleDateString('en-CA');
        }

        async function exportExcel() {
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;

            if (!fechaInicio || !fechaFin) {
                alert('Selecciona las fechas del reporte');
                return;
            }
            if (fechaInicio > fechaFin) {
                alert('La fecha de inicio debe ser anterior a la fecha fin');
                return;
            }

            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Generando...';
            btn.disabled = true;

            try {
                const url = `${API_BASE}/time/report?studio_id=${studioId}&fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`;
                const response = await fetch(url);

                if (!response.ok) throw new Error('Error generando reporte');

                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `Reporte_Tiempo_${fechaInicio}_${fechaFin}.xlsx`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(downloadUrl);
            } catch (error) {
                console.error('Error:', error);
                alert('Error al generar el reporte');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function loadData() {
            const date = document.getElementById('selectedDate').value;

            try {
                const response = await fetch(`${API_BASE}/time/studio-view?studio_id=${studioId}&date=${date}`);
                const data = await response.json();

                if (data.success) {
                    studioSettings = data.settings;
                    modelsData = data.models;

                    // Update summary
                    document.getElementById('totalModels').textContent = data.summary.totalModels;
                    document.getElementById('onlineCount').textContent = data.summary.online;
                    document.getElementById('breakCount').textContent = data.summary.onBreak;
                    document.getElementById('offlineCount').textContent = data.summary.offline;
                    document.getElementById('cumpleCount').textContent = data.summary.cumpliendo;
                    document.getElementById('totalEarnings').textContent = data.summary.totalEarnings.toLocaleString();

                    // Render table
                    renderModelsTable(data.models);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function renderModelsTable(models) {
            const tbody = document.getElementById('modelsTableBody');

            if (models.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-6 py-8 text-center text-gray-500">
                            No hay modelos registrados
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = models.map(model => {
                const statusBadge = getStatusBadge(model.status);
                const checkIn = model.checkInTime ? formatTime(model.checkInTime) : '-';
                const checkOut = model.checkOutTime ? formatTime(model.checkOutTime) : '-';
                const workedTime = formatMinutes(model.totalWorkedMinutes);
                const complianceBadge = getComplianceBadge(model.compliance, model.dayNote);

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center mr-3">
                                    <span class="text-purple-600 font-semibold">${model.name.charAt(0)}</span>
                                </div>
                                <div>
                                    <div class="font-medium text-gray-900">${model.name}</div>
                                    ${model.dayNote ? `<div class="text-xs text-gray-500">${getNoteLabel(model.dayNote.note_type)}</div>` : ''}
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-center">${statusBadge}</td>
                        <td class="px-6 py-4 text-center text-sm">${checkIn}</td>
                        <td class="px-6 py-4 text-center text-sm">${checkOut}</td>
                       <td class="px-6 py-4 text-center">
    <span class="font-mono font-medium">${workedTime}</span>
    <div class="text-xs text-gray-500">${model.breaksCount} breaks (${model.totalBreakMinutes}m)${model.breakExcessMinutes > 0 ? ` <span class="text-red-500">‚ö†Ô∏è +${model.breakExcessMinutes}m</span>` : ''}</div>
    ${model.minutesPending > 0 ? `<div class="text-xs text-red-500">Faltan: ${model.minutesPending}m</div>` : ''}
</td>
                        <td class="px-6 py-4">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="h-2 rounded-full ${model.progressPercent >= 100 ? 'bg-green-500' : 'bg-purple-500'}" 
                                     style="width: ${model.progressPercent}%"></div>
                            </div>
                            <div class="text-xs text-center text-gray-500 mt-1">${model.progressPercent}%</div>
                        </td>
                        <td class="px-6 py-4 text-center">${complianceBadge}</td>
                        <td class="px-6 py-4 text-center">
                            <span class="font-medium">${model.totalEarnings.toLocaleString()}</span>
                            ${model.earnings.length > 0 ? `
                                <div class="text-xs text-gray-500">
                                    ${model.earnings.map(e => `${e.platform}: ${e.earnings}`).join(', ')}
                                </div>
                            ` : ''}
                        </td>
                        <td class="px-6 py-4 text-center">
    <div class="flex justify-center gap-2">
        <button onclick="openEditTimeModal('${model.id}', '${model.name}')" 
                class="text-blue-600 hover:text-blue-800" title="Editar tiempo">
            ‚úèÔ∏è
        </button>
        <button onclick="openEarningsModal('${model.id}', '${model.name}')" 
                class="text-purple-600 hover:text-purple-800" title="Ingresar ganancias">
            üí∞
        </button>
        <button onclick="openNoteModal('${model.id}', '${model.name}')" 
                class="text-gray-600 hover:text-gray-800" title="Agregar nota">
            üìù
        </button>
    </div>
</td>
                    </tr>
                `;
            }).join('');
        }

        function getStatusBadge(status) {
            const badges = {
                'working': '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">üü¢ Online</span>',
                'on_break': '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">üü° Break</span>',
                'offline': '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">‚ö´ Offline</span>'
            };
            return badges[status] || badges['offline'];
        }

        function getComplianceBadge(compliance, dayNote) {
            if (dayNote) {
                return `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">üìù ${getNoteLabel(dayNote.note_type)}</span>`;
            }
            if (!compliance) return '<span class="text-gray-400">-</span>';
            if (compliance === 'CUMPLE') {
                return '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">‚úÖ Cumple</span>';
            }
            return '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">‚ùå No cumple</span>';
        }

        function getNoteLabel(noteType, customName = null) {
            const labels = {
                'permission': 'üìã Permiso',
                'absence': '‚ùå Falta',
                'late': '‚è∞ Lleg√≥ tarde',
                'left_early': 'üèÉ Sali√≥ temprano',
                'other': customName ? `üìå ${customName}` : 'üìå Otro'
            };
            return labels[noteType] || noteType;
        }

        function formatTime(isoString) {
            if (!isoString) return '-';
            // Agregar Z si no la tiene para forzar interpretaci√≥n UTC
            const utcString = isoString.endsWith('Z') ? isoString : isoString + 'Z';
            const date = new Date(utcString);
            return date.toLocaleTimeString('es-CO', {
                hour: '2-digit',
                minute: '2-digit',
                timeZone: 'America/Bogota'
            });
        }

        function formatMinutes(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours}h ${mins}m`;
        }

        // === EARNINGS MODAL ===
        function openEarningsModal(modelId, modelName) {
            document.getElementById('modalModelId').value = modelId;
            document.getElementById('modalModelName').textContent = modelName;

            // Get platforms from settings
            const platforms = studioSettings.platforms || ['chaturbate', 'stripchat'];

            // Find existing earnings for this model
            const model = modelsData.find(m => m.id === modelId);
            const existingEarnings = model ? model.earnings : [];

            // Build platform inputs
            const inputsHtml = platforms.map(platform => {
                const existing = existingEarnings.find(e => e.platform === platform);
                const currencyMap = {
                    chaturbate: 'tokens', stripchat: 'tokens', xmodels: 'credits',
                    streamate: 'gold', flirt4free: 'credits', cam4: 'gold'
                };
                const currency = currencyMap[platform] || 'tokens';

                return `
                    <div class="border rounded-lg p-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2 capitalize">${platform}</label>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-gray-500">Ganancias (${currency})</label>
                                <input type="number" id="earnings_${platform}" value="${existing?.earnings || 0}" 
                                       class="w-full px-3 py-2 border rounded-lg" min="0">
                            </div>
                            ${studioSettings.track_followers ? `
                            <div>
                                <label class="text-xs text-gray-500">Seguidores (inicio)</label>
                                <input type="number" id="followers_start_${platform}" value="${existing?.followers_start || 0}" 
                                       class="w-full px-3 py-2 border rounded-lg" min="0">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Seguidores (fin)</label>
                                <input type="number" id="followers_end_${platform}" value="${existing?.followers_end || 0}" 
                                       class="w-full px-3 py-2 border rounded-lg" min="0">
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('platformInputs').innerHTML = inputsHtml;
            document.getElementById('earningsModal').classList.remove('hidden');
            document.getElementById('earningsModal').classList.add('flex');
        }

        function closeEarningsModal() {
            document.getElementById('earningsModal').classList.add('hidden');
            document.getElementById('earningsModal').classList.remove('flex');
        }

        async function saveEarnings() {
            const modelId = document.getElementById('modalModelId').value;
            const date = document.getElementById('selectedDate').value;
            const platforms = studioSettings.platforms || ['chaturbate', 'stripchat'];

            for (const platform of platforms) {
                const earnings = parseFloat(document.getElementById(`earnings_${platform}`).value) || 0;
                const followers_start = studioSettings.track_followers ?
                    parseInt(document.getElementById(`followers_start_${platform}`).value) || 0 : 0;
                const followers_end = studioSettings.track_followers ?
                    parseInt(document.getElementById(`followers_end_${platform}`).value) || 0 : 0;

                try {
                    await fetch(`${API_BASE}/time/earnings`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model_id: modelId,
                            studio_id: studioId,
                            date,
                            platform,
                            earnings,
                            followers_start,
                            followers_end
                        })
                    });
                } catch (error) {
                    console.error('Error saving earnings:', error);
                }
            }

            closeEarningsModal();
            loadData();
        }

        // === NOTE MODAL ===
        function toggleCustomName() {
            const noteType = document.getElementById('noteType').value;
            const container = document.getElementById('customNameContainer');
            if (noteType === 'other') {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        function openNoteModal(modelId, modelName) {
            document.getElementById('noteModalModelId').value = modelId;
            document.getElementById('noteModalModelName').textContent = modelName;
            document.getElementById('noteType').value = 'permission';
            document.getElementById('noteText').value = '';
            document.getElementById('customName').value = '';
            document.getElementById('mustRecover').checked = false;
            document.getElementById('customNameContainer').classList.add('hidden');

            document.getElementById('noteModal').classList.remove('hidden');
            document.getElementById('noteModal').classList.add('flex');
        }

        function closeNoteModal() {
            document.getElementById('noteModal').classList.add('hidden');
            document.getElementById('noteModal').classList.remove('flex');
        }

        async function saveNote() {
            const modelId = document.getElementById('noteModalModelId').value;
            const date = document.getElementById('selectedDate').value;
            const noteType = document.getElementById('noteType').value;
            const note = document.getElementById('noteText').value;
            const customName = document.getElementById('customName').value;
            const mustRecover = document.getElementById('mustRecover').checked;

            try {
                await fetch(`${API_BASE}/time/day-note`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model_id: modelId,
                        studio_id: studioId,
                        date,
                        note_type: noteType,
                        note,
                        custom_name: noteType === 'other' ? customName : null,
                        must_recover: mustRecover
                    })
                });

                closeNoteModal();
                loadData();
            } catch (error) {
                console.error('Error saving note:', error);
            }
        }

        function logout() {
            localStorage.removeItem('studio_id');
            localStorage.removeItem('studio_name');
            window.location.href = '/dashboard/login.html';
        }

        // === BALANCE ===
        async function loadBalance() {
            const container = document.getElementById('balanceContainer');
            container.innerHTML = '<div class="col-span-3 text-center text-gray-500">Cargando...</div>';

            // Obtener primer d√≠a del mes
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toLocaleDateString('en-CA');
            const today = now.toLocaleDateString('en-CA');

            try {
                const res = await fetch(`${API_BASE}/time/balance?studio_id=${studioId}&start_date=${firstDay}&end_date=${today}`);
                const data = await res.json();

                if (!data.success) throw new Error(data.error);

                if (data.balances.length === 0) {
                    container.innerHTML = '<div class="col-span-3 text-center text-gray-500">No hay datos</div>';
                    return;
                }

                container.innerHTML = data.balances.map(b => {
                    const hours = Math.floor(Math.abs(b.balance_minutes) / 60);
                    const mins = Math.abs(b.balance_minutes) % 60;
                    const sign = b.balance_minutes >= 0 ? '+' : '-';
                    const balanceText = `${sign}${hours}h ${mins}m`;

                    let statusClass, statusIcon, statusBg;
                    if (b.status === 'ok') {
                        statusClass = 'text-green-600';
                        statusIcon = '‚úÖ';
                        statusBg = 'bg-green-50 border-green-200';
                    } else if (b.status === 'warning') {
                        statusClass = 'text-yellow-600';
                        statusIcon = '‚ö†Ô∏è';
                        statusBg = 'bg-yellow-50 border-yellow-200';
                    } else {
                        statusClass = 'text-red-600';
                        statusIcon = 'üî¥';
                        statusBg = 'bg-red-50 border-red-200';
                    }

                    const workedHours = Math.floor(b.worked_minutes / 60);
                    const workedMins = b.worked_minutes % 60;
                    const expectedHours = Math.floor(b.expected_minutes / 60);
                    const expectedMins = b.expected_minutes % 60;

                    return `
                <div class="border rounded-lg p-4 ${statusBg}">
                    <div class="flex justify-between items-start mb-2">
                        <span class="font-medium text-gray-800">${b.model_name}</span>
                        <span class="text-lg">${statusIcon}</span>
                    </div>
                    <div class="text-2xl font-bold ${statusClass} mb-2">${balanceText}</div>
                    <div class="text-xs text-gray-500">
                        <div>Trabajado: ${workedHours}h ${workedMins}m</div>
                        <div>Esperado: ${expectedHours}h ${expectedMins}m</div>
                        <div>D√≠as: ${b.days_worked}</div>
                    </div>
                </div>
            `;
                }).join('');

            } catch (error) {
                console.error('Error loading balance:', error);
                container.innerHTML = '<div class="col-span-3 text-center text-red-500">Error cargando balance</div>';
            }
        }

        // Cargar balance al inicio
        loadBalance();

        // === EDIT TIME MODAL ===
        async function openEditTimeModal(modelId, modelName) {
            document.getElementById('editTimeModelId').value = modelId;
            document.getElementById('editTimeModelName').textContent = modelName;

            const date = document.getElementById('selectedDate').value;
            document.getElementById('editTimeDate').textContent = date;

            // Limpiar campos
            document.getElementById('editCheckIn').value = '';
            document.getElementById('editCheckOut').value = '';
            document.getElementById('editTimeReason').value = '';

            // Cargar registros existentes
            try {
                const res = await fetch(`${API_BASE}/time/manual-entry?model_id=${modelId}&date=${date}`);
                const data = await res.json();

                if (data.success && data.parsed) {
                    if (data.parsed.checkIn) {
                        const checkInTime = new Date(data.parsed.checkIn.created_at);
                        document.getElementById('editCheckIn').value =
                            checkInTime.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'America/Bogota' });
                    }
                    if (data.parsed.checkOut) {
                        const checkOutTime = new Date(data.parsed.checkOut.created_at);
                        document.getElementById('editCheckOut').value =
                            checkOutTime.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'America/Bogota' });
                    }
                }
            } catch (error) {
                console.error('Error loading time entries:', error);
            }

            document.getElementById('editTimeModal').classList.remove('hidden');
            document.getElementById('editTimeModal').classList.add('flex');
        }

        function closeEditTimeModal() {
            document.getElementById('editTimeModal').classList.add('hidden');
            document.getElementById('editTimeModal').classList.remove('flex');
        }

        async function saveTimeEdit() {
            const modelId = document.getElementById('editTimeModelId').value;
            const date = document.getElementById('selectedDate').value;
            const checkIn = document.getElementById('editCheckIn').value;
            const checkOut = document.getElementById('editCheckOut').value;
            const reason = document.getElementById('editTimeReason').value;

            if (!checkIn && !checkOut) {
                alert('Ingresa al menos entrada o salida');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/time/manual-entry`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model_id: modelId,
                        studio_id: studioId,
                        date,
                        check_in: checkIn || null,
                        check_out: checkOut || null,
                        edited_reason: reason
                    })
                });

                const data = await res.json();

                if (data.success) {
                    closeEditTimeModal();
                    loadData();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar');
            }
        }

        async function deleteTimeEntry() {
            if (!confirm('¬øEliminar todos los registros de tiempo de este d√≠a?')) return;

            const modelId = document.getElementById('editTimeModelId').value;
            const date = document.getElementById('selectedDate').value;

            try {
                const res = await fetch(`${API_BASE}/time/manual-entry`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model_id: modelId, date })
                });

                const data = await res.json();

                if (data.success) {
                    closeEditTimeModal();
                    loadData();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Resaltar p√°gina activa en el men√∫
        document.querySelectorAll('aside nav a').forEach(link => {
            if (link.href === window.location.href) {
                link.classList.remove('hover:bg-white/10');
                link.classList.add('bg-white/20');
            }
        });

        // function exportCSV() {
        //     if (!modelsData || modelsData.length === 0) {
        //         alert('No hay datos para exportar');
        //         return;
        //     }

        //     // Encabezados
        //     const headers = [
        //         'Fecha',
        //         'Modelo',
        //         'Inicio Conexi√≥n',
        //         'Fin Conexi√≥n',
        //         'Tiempo Real',
        //         'Estado',
        //         'Minutos Pendientes',
        //         'Breaks',
        //         'Tiempo Break',
        //         'Exceso Break',
        //         'Ganancias',
        //         'Seguidores Inicio',
        //         'Seguidores Fin',
        //         'Seguidores Ganados',
        //         'Observaciones'
        //     ];

        //     // Filas de datos
        //     const rows = modelsData.map(model => {
        //         // Calcular ganancias por plataforma
        //         const earningsStr = model.earnings && model.earnings.length > 0
        //             ? model.earnings.map(e => `${e.platform}: ${e.earnings} ${e.currency_type}`).join(' | ')
        //             : '0';

        //         // Calcular seguidores totales (suma de todas las plataformas)
        //         const followersStart = model.earnings?.reduce((sum, e) => sum + (e.followers_start || 0), 0) || 0;
        //         const followersEnd = model.earnings?.reduce((sum, e) => sum + (e.followers_end || 0), 0) || 0;
        //         const followersGained = followersEnd - followersStart;

        //         return [
        //             document.getElementById('selectedDate').value,
        //             model.name,
        //             model.checkInTime ? formatTime(model.checkInTime) : '-',
        //             model.checkOutTime ? formatTime(model.checkOutTime) : '-',
        //             `${Math.floor(model.totalWorkedMinutes / 60)}h ${model.totalWorkedMinutes % 60}m`,
        //             model.compliance || '-',
        //             model.minutesPending || 0,
        //             model.breaksCount || 0,
        //             `${model.totalBreakMinutes || 0}m`,
        //             `${model.breakExcessMinutes || 0}m`,
        //             earningsStr,
        //             followersStart,
        //             followersEnd,
        //             followersGained,
        //             model.dayNote?.note || ''
        //         ];
        //     });

        //     // Construir CSV
        //     let csv = headers.join(',') + '\n';
        //     rows.forEach(row => {
        //         // Escapar comas y comillas en los valores
        //         const escapedRow = row.map(val => {
        //             const str = String(val);
        //             if (str.includes(',') || str.includes('"') || str.includes('\n')) {
        //                 return `"${str.replace(/"/g, '""')}"`;
        //             }
        //             return str;
        //         });
        //         csv += escapedRow.join(',') + '\n';
        //     });

        //     // Descargar
        //     const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
        //     const url = URL.createObjectURL(blob);
        //     const link = document.createElement('a');
        //     link.href = url;
        //     link.download = `reporte_${document.getElementById('selectedDate').value}.csv`;
        //     link.click();
        //     URL.revokeObjectURL(url);
        // }
    </script>
</body>

</html>