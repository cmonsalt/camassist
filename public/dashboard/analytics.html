<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - CamAssist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="/LogosMarca/icon16.png" type="image/png">
    <style>
        .platform-cb {
            background: linear-gradient(135deg, #f97316, #ea580c);
        }

        .platform-sc {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }

        .platform-xm {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .platform-st {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
        }

        .trend-up {
            color: #10b981;
        }

        .trend-down {
            color: #ef4444;
        }
    </style>
</head>

<body class="bg-gray-50">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-gradient-to-b from-purple-700 to-pink-600 min-h-screen p-6 text-white fixed">
            <div class="flex items-center mb-8">
                <span class="text-2xl mr-2">ü§ñ</span>
                <h1 class="text-xl font-bold">CamAssist</h1>
            </div>
            <nav class="space-y-2">
                <a href="/dashboard/index.html"
                    class="flex items-center px-4 py-3 rounded-lg hover:bg-white/10 transition"><span
                        class="mr-3">üìä</span> Dashboard</a>
                <a href="/dashboard/modelos.html"
                    class="flex items-center px-4 py-3 rounded-lg hover:bg-white/10 transition"><span
                        class="mr-3">üë©‚Äçüíº</span> Modelos</a>
                <a href="/dashboard/analytics.html"
                    class="flex items-center px-4 py-3 rounded-lg hover:bg-white/10 transition"><span class="mr-3">üí∞</span>
                    Analytics</a>
                <a href="/dashboard/tiempo.html"
                    class="flex items-center px-4 py-3 rounded-lg hover:bg-white/10 transition"><span
                        class="mr-3">‚è±Ô∏è</span> Tiempo</a>
                <a href="/dashboard/tiempo-config.html"
                    class="flex items-center px-4 py-3 rounded-lg hover:bg-white/10 transition"><span
                        class="mr-3">‚öôÔ∏è</span> Configurar Tiempo</a>
                <a href="/dashboard/extensiones.html"
                    class="flex items-center px-4 py-3 rounded-lg hover:bg-white/10 transition"><span
                        class="mr-3">üß©</span> Extensiones</a>
                <a href="/dashboard/facturacion.html"
                    class="flex items-center px-4 py-3 rounded-lg hover:bg-white/10 transition"><span
                        class="mr-3">üí≥</span> Facturaci√≥n</a>
            </nav>
            <div class="absolute bottom-6 left-6 right-6">
                <div class="mb-4 text-sm opacity-80">
                    <div class="text-white/60">Studio</div>
                    <div class="font-semibold" id="studioName">Cargando...</div>
                </div>
                <button onclick="logout()"
                    class="w-full flex items-center justify-center px-4 py-2 rounded-lg hover:bg-white/10 transition"><span
                        class="mr-2">üö™</span> Salir</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto ml-64">
            <div class="p-8">
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-800">üí∞ Analytics de Ganancias</h1>
                    <p class="text-gray-600">Tokens y seguidores sincronizados autom√°ticamente</p>
                </div>

                <!-- Filtros -->
                <div class="bg-white rounded-xl shadow-sm p-4 mb-6 flex flex-wrap gap-4 items-center">
                    <div>
                        <label class="text-sm text-gray-600 block mb-1">Per√≠odo</label>
                        <select id="periodFilter" onchange="loadAnalytics()" class="px-4 py-2 border rounded-lg">
                            <option value="today">Hoy</option>
                            <option value="week">Esta semana</option>
                            <option value="month">Este mes</option>
                            <option value="90days" selected>√öltimos 90 d√≠as</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm text-gray-600 block mb-1">Plataforma</label>
                        <select id="platformFilter" onchange="loadAnalytics()" class="px-4 py-2 border rounded-lg">
                            <option value="all">Todas</option>
                            <option value="chaturbate">üü† Chaturbate</option>
                            <option value="stripchat">üî¥ StripChat</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm text-gray-600 block mb-1">Modelo</label>
                        <select id="modelFilter" onchange="loadAnalytics()" class="px-4 py-2 border rounded-lg">
                            <option value="all">Todas las modelos</option>
                        </select>
                    </div>
                </div>

                <!-- Proyecciones -->
                <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl shadow-sm p-6 mb-8 text-white">
                    <h2 class="text-xl font-semibold mb-4">üîÆ Proyecciones e Insights</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white/10 rounded-lg p-4">
                            <p class="text-white/70 text-sm">Si sigues as√≠, este mes ganar√°s</p>
                            <p class="text-3xl font-bold" id="projectedMonthly">-</p>
                            <p class="text-sm text-white/60" id="projectedMonthlyUSD">$0 USD</p>
                        </div>
                        <div class="bg-white/10 rounded-lg p-4">
                            <p class="text-white/70 text-sm">Promedio diario</p>
                            <p class="text-3xl font-bold" id="avgPerDay">-</p>
                            <p class="text-sm text-white/60">tokens/d√≠a</p>
                        </div>
                        <div class="bg-white/10 rounded-lg p-4">
                            <p class="text-white/70 text-sm">Tu mejor modelo</p>
                            <p class="text-2xl font-bold" id="bestModelName">-</p>
                            <p class="text-sm text-white/60" id="bestModelPercent">Produce X% de ingresos</p>
                        </div>
                    </div>
                </div>

                <!-- Comparativas -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">üìà vs Per√≠odo Anterior</h2>
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Per√≠odo actual</p>
                                <p class="text-2xl font-bold" id="currentPeriodTokens">-</p>
                            </div>
                            <div class="text-4xl" id="comparisonArrow">‚Üí</div>
                            <div>
                                <p class="text-gray-500 text-sm">Per√≠odo anterior</p>
                                <p class="text-2xl font-bold text-gray-400" id="prevPeriodTokens">-</p>
                            </div>
                        </div>
                        <div class="mt-4 text-center">
                            <span class="text-2xl font-bold" id="comparisonPercent">0%</span>
                            <span class="text-gray-500" id="comparisonLabel">sin cambio</span>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">üèÜ CB vs StripChat</h2>
                        <div class="space-y-3">
                            <div>
                                <div class="flex justify-between text-sm mb-1"><span>üü† Chaturbate</span><span
                                        id="cbComparePercent">0%</span></div>
                                <div class="w-full bg-gray-200 rounded-full h-4">
                                    <div id="cbProgressBar" class="bg-orange-500 h-4 rounded-full" style="width: 0%">
                                    </div>
                                </div>
                                <p class="text-right text-sm text-gray-500" id="cbCompareTokens">0 tk</p>
                            </div>
                            <div>
                                <div class="flex justify-between text-sm mb-1"><span>üî¥ StripChat</span><span
                                        id="scComparePercent">0%</span></div>
                                <div class="w-full bg-gray-200 rounded-full h-4">
                                    <div id="scProgressBar" class="bg-red-500 h-4 rounded-full" style="width: 0%"></div>
                                </div>
                                <p class="text-right text-sm text-gray-500" id="scCompareTokens">0 tk</p>
                            </div>
                        </div>
                        <p class="text-center mt-4 text-sm" id="platformWinner">-</p>
                    </div>
                </div>

                <!-- Cards por Plataforma -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="platform-cb p-4 text-white">
                            <div class="flex items-center justify-between"><span
                                    class="text-lg font-semibold">Chaturbate</span><span
                                    class="text-xs bg-white/20 px-2 py-1 rounded">ü§ñ Auto</span></div>
                        </div>
                        <div class="p-4">
                            <div class="flex justify-between items-center mb-2"><span
                                    class="text-gray-600 text-sm">Tokens</span><span
                                    class="text-2xl font-bold text-orange-600" id="cbTokens">-</span></div>
                            <div class="flex justify-between items-center"><span
                                    class="text-gray-600 text-sm">Seguidores</span><span
                                    class="text-lg font-semibold text-gray-800" id="cbFollowers">-</span></div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="platform-sc p-4 text-white">
                            <div class="flex items-center justify-between"><span
                                    class="text-lg font-semibold">StripChat</span><span
                                    class="text-xs bg-white/20 px-2 py-1 rounded">ü§ñ Auto</span></div>
                        </div>
                        <div class="p-4">
                            <div class="flex justify-between items-center mb-2"><span
                                    class="text-gray-600 text-sm">Tokens</span><span
                                    class="text-2xl font-bold text-red-600" id="scTokens">-</span></div>
                            <div class="flex justify-between items-center"><span
                                    class="text-gray-600 text-sm">Seguidores</span><span
                                    class="text-lg font-semibold text-gray-800" id="scFollowers">-</span></div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden opacity-50">
                        <div class="platform-xm p-4 text-white"><span class="text-lg font-semibold">XModels</span></div>
                        <div class="p-4 text-center text-gray-400 py-6">üîú Pr√≥ximamente</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden opacity-50">
                        <div class="platform-st p-4 text-white"><span class="text-lg font-semibold">Streamate</span>
                        </div>
                        <div class="p-4 text-center text-gray-400 py-6">üîú Pr√≥ximamente</div>
                    </div>
                </div>

                <!-- Totales -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-gradient-to-r from-purple-600 to-pink-600 rounded-xl shadow-sm p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-white/80 text-sm">Total Tokens</p>
                                <p class="text-4xl font-bold" id="totalTokens">-</p>
                            </div>
                            <div class="text-5xl opacity-50">üíé</div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl shadow-sm p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-white/80 text-sm">Seguidores Ganados</p>
                                <p class="text-4xl font-bold" id="totalFollowers">-</p>
                            </div>
                            <div class="text-5xl opacity-50">üë•</div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-blue-500 to-cyan-600 rounded-xl shadow-sm p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-white/80 text-sm">Valor Estimado USD</p>
                                <p class="text-4xl font-bold" id="totalUSD">-</p>
                            </div>
                            <div class="text-5xl opacity-50">üíµ</div>
                        </div>
                    </div>
                </div>

                <!-- Mejor D√≠a y Horario -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">üìÖ Mejor D√≠a de la Semana</h2>
                        <div class="text-center mb-4"><span class="text-4xl">üèÜ</span>
                            <p class="text-2xl font-bold text-purple-600" id="bestDayName">-</p>
                            <p class="text-gray-500" id="bestDayTokens">0 tokens</p>
                        </div>
                        <canvas id="daysChart" height="150"></canvas>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">üïê Mejor Horario</h2>
                        <div class="text-center mb-4"><span class="text-4xl">‚è∞</span>
                            <p class="text-2xl font-bold text-purple-600" id="bestHourTime">-</p>
                            <p class="text-gray-500" id="bestHourTokens">0 tokens</p>
                        </div>
                        <canvas id="hoursChart" height="150"></canvas>
                    </div>
                </div>

                <!-- Gr√°fico de Ganancias -->
                <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">üìà Ganancias por D√≠a</h2>
                    <canvas id="earningsChart" height="100"></canvas>
                </div>

                <!-- Top Modelos y Fans -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">üèÜ Top Modelos por Tokens</h2>
                        <div id="topModelsList" class="space-y-3">
                            <div class="text-gray-400 text-center py-4">Cargando...</div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">üíé Top Fans que m√°s pagan</h2>
                        <div id="topFansList" class="space-y-3">
                            <div class="text-gray-400 text-center py-4">Cargando...</div>
                        </div>
                    </div>
                </div>

                <!-- Estad√≠sticas de Fans -->
                <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">üë• Estad√≠sticas de Fans</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <p class="text-3xl font-bold text-purple-600" id="totalFans">-</p>
                            <p class="text-sm text-gray-500">Total Fans</p>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <p class="text-3xl font-bold text-green-600" id="recurringFans">-</p>
                            <p class="text-sm text-gray-500">Recurrentes</p>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <p class="text-3xl font-bold text-blue-600" id="newFans">-</p>
                            <p class="text-sm text-gray-500">Nuevos</p>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <p class="text-3xl font-bold text-orange-600" id="avgTipPerFan">-</p>
                            <p class="text-sm text-gray-500">Promedio por Fan</p>
                        </div>
                    </div>
                </div>

                <!-- Transacciones -->
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-6 border-b flex justify-between items-center">
                        <h2 class="text-xl font-semibold text-gray-800">üìã Transacciones Recientes</h2>
                        <button onclick="exportCSV()"
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm">üì•
                            Exportar CSV</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Modelo
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                        Plataforma</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fan</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Tokens
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTable" class="divide-y divide-gray-200">
                                <tr>
                                    <td colspan="6" class="px-6 py-8 text-center text-gray-400">Cargando...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = 'https://camassist.vercel.app/api';
        const studioId = localStorage.getItem('studio_id');
        const studioName = localStorage.getItem('studio_name');
        let earningsChart = null, daysChart = null, hoursChart = null;
        let allTransactions = [];

        if (!studioId) window.location.href = '/dashboard/login.html';
        if (studioName) document.getElementById('studioName').textContent = studioName;

        function logout() { localStorage.clear(); window.location.href = '/dashboard/login.html'; }

        async function loadModels() {
            try {
                const response = await fetch(`${API_BASE}/get-models`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ studio_id: studioId }) });
                const data = await response.json();
                if (data.success) {
                    const select = document.getElementById('modelFilter');
                    data.models.forEach(model => { const option = document.createElement('option'); option.value = model.id; option.textContent = model.name; select.appendChild(option); });
                }
            } catch (error) { console.error('Error loading models:', error); }
        }

        async function loadAnalytics() {
            const period = document.getElementById('periodFilter').value;
            const platform = document.getElementById('platformFilter').value;
            const modelId = document.getElementById('modelFilter').value;

            try {
                const response = await fetch(`${API_BASE}/get-analytics`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ studio_id: studioId, period, platform: platform === 'all' ? null : platform, model_id: modelId === 'all' ? null : modelId })
                });
                const data = await response.json();

                if (data.success) {
                    // Plataformas
                    document.getElementById('cbTokens').textContent = data.byPlatform.chaturbate?.tokens?.toLocaleString() || '0';
                    const cbTotal = data.byPlatform.chaturbate?.followersTotal || 0;
                    const cbGained = data.byPlatform.chaturbate?.followers || 0;
                    document.getElementById('cbFollowers').innerHTML = `${cbTotal} <span class="text-green-600 text-sm">(+${cbGained})</span>`;

                    document.getElementById('scTokens').textContent = data.byPlatform.stripchat?.tokens?.toLocaleString() || '0';
                    const scTotal = data.byPlatform.stripchat?.followersTotal || 0;
                    const scGained = data.byPlatform.stripchat?.followers || 0;
                    document.getElementById('scFollowers').innerHTML = `${scTotal} <span class="text-green-600 text-sm">(+${scGained})</span>`;

                    // Totales
                    document.getElementById('totalTokens').textContent = data.totals.tokens.toLocaleString();
                    document.getElementById('totalFollowers').innerHTML = `${data.totals.followersTotal} <span class="text-sm opacity-80">(+${data.totals.followers})</span>`;
                    document.getElementById('totalUSD').textContent = '$' + data.totals.usd.toFixed(2);

                    // Proyecciones
                    document.getElementById('projectedMonthly').textContent = data.projections.projectedMonthly.toLocaleString() + ' tk';
                    document.getElementById('projectedMonthlyUSD').textContent = '$' + data.projections.projectedMonthlyUSD + ' USD';
                    document.getElementById('avgPerDay').textContent = data.projections.avgTokensPerDay.toLocaleString();
                    if (data.projections.bestModel) {
                        document.getElementById('bestModelName').textContent = data.projections.bestModel.name;
                        document.getElementById('bestModelPercent').textContent = `Produce ${data.projections.bestModel.percent}% de ingresos`;
                    }

                    // Comparativa per√≠odo anterior
                    document.getElementById('currentPeriodTokens').textContent = data.comparison.currentTokens.toLocaleString() + ' tk';
                    document.getElementById('prevPeriodTokens').textContent = data.comparison.previousTokens.toLocaleString() + ' tk';
                    const pctChange = data.comparison.percentChange;
                    const comparisonEl = document.getElementById('comparisonPercent');
                    const arrowEl = document.getElementById('comparisonArrow');
                    const labelEl = document.getElementById('comparisonLabel');
                    if (pctChange > 0) { comparisonEl.textContent = '+' + pctChange + '%'; comparisonEl.className = 'text-2xl font-bold trend-up'; arrowEl.textContent = 'üìà'; labelEl.textContent = 'de aumento'; }
                    else if (pctChange < 0) { comparisonEl.textContent = pctChange + '%'; comparisonEl.className = 'text-2xl font-bold trend-down'; arrowEl.textContent = 'üìâ'; labelEl.textContent = 'de disminuci√≥n'; }
                    else { comparisonEl.textContent = '0%'; comparisonEl.className = 'text-2xl font-bold text-gray-500'; arrowEl.textContent = '‚Üí'; labelEl.textContent = 'sin cambio'; }

                    // CB vs SC
                    document.getElementById('cbComparePercent').textContent = data.platformComparison.cbPercent + '%';
                    document.getElementById('scComparePercent').textContent = data.platformComparison.scPercent + '%';
                    document.getElementById('cbProgressBar').style.width = data.platformComparison.cbPercent + '%';
                    document.getElementById('scProgressBar').style.width = data.platformComparison.scPercent + '%';
                    document.getElementById('cbCompareTokens').textContent = data.platformComparison.chaturbate.toLocaleString() + ' tk';
                    document.getElementById('scCompareTokens').textContent = data.platformComparison.stripchat.toLocaleString() + ' tk';
                    document.getElementById('platformWinner').innerHTML = data.platformComparison.winner === 'chaturbate'
                        ? 'üèÜ <span class="text-orange-600 font-semibold">Chaturbate</span> rinde m√°s'
                        : 'üèÜ <span class="text-red-600 font-semibold">StripChat</span> rinde m√°s';

                    // Mejor d√≠a
                    document.getElementById('bestDayName').textContent = data.bestDay.name;
                    document.getElementById('bestDayTokens').textContent = data.bestDay.tokens.toLocaleString() + ' tokens';
                    renderDaysChart(data.bestDay.allDays);

                    // Mejor horario
                    document.getElementById('bestHourTime').textContent = data.bestHour.formatted;
                    document.getElementById('bestHourTokens').textContent = data.bestHour.tokens.toLocaleString() + ' tokens';
                    renderHoursChart(data.bestHour.allHours);

                    // Fan stats
                    document.getElementById('totalFans').textContent = data.fanStats.total;
                    document.getElementById('recurringFans').textContent = data.fanStats.recurring;
                    document.getElementById('newFans').textContent = data.fanStats.new;
                    document.getElementById('avgTipPerFan').textContent = data.fanStats.avgTipPerFan + ' tk';

                    renderChart(data.dailyData);
                    renderTopModels(data.topModels);
                    renderTopFans(data.topFans);
                    allTransactions = data.transactions;
                    renderTransactions(data.transactions);
                }
            } catch (error) { console.error('Error loading analytics:', error); }
        }

        function renderChart(dailyData) {
            const ctx = document.getElementById('earningsChart').getContext('2d');
            if (earningsChart) earningsChart.destroy();
            earningsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dailyData.map(d => d.date), datasets: [
                        { label: 'Chaturbate', data: dailyData.map(d => d.chaturbate || 0), backgroundColor: 'rgba(249, 115, 22, 0.8)', borderRadius: 4 },
                        { label: 'StripChat', data: dailyData.map(d => d.stripchat || 0), backgroundColor: 'rgba(220, 38, 38, 0.8)', borderRadius: 4 }
                    ]
                },
                options: { responsive: true, plugins: { legend: { position: 'top' } }, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } }
            });
        }

        function renderDaysChart(days) {
            const ctx = document.getElementById('daysChart').getContext('2d');
            if (daysChart) daysChart.destroy();
            const maxTokens = Math.max(...days.map(x => x.tokens));
            daysChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: days.map(d => d.name.substring(0, 3)), datasets: [{ data: days.map(d => d.tokens), backgroundColor: days.map(d => d.tokens === maxTokens ? 'rgba(139, 92, 246, 0.8)' : 'rgba(229, 231, 235, 0.8)'), borderRadius: 4 }] },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }

        function renderHoursChart(hours) {
            const ctx = document.getElementById('hoursChart').getContext('2d');
            if (hoursChart) hoursChart.destroy();
            const blocks = [];
            for (let i = 0; i < 24; i += 4) { blocks.push({ label: `${i}-${i + 4}h`, tokens: hours.slice(i, i + 4).reduce((a, b) => a + b.tokens, 0) }); }
            const maxTokens = Math.max(...blocks.map(x => x.tokens));
            hoursChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: blocks.map(b => b.label), datasets: [{ data: blocks.map(b => b.tokens), backgroundColor: blocks.map(b => b.tokens === maxTokens ? 'rgba(139, 92, 246, 0.8)' : 'rgba(229, 231, 235, 0.8)'), borderRadius: 4 }] },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }

        function renderTopModels(models) {
            const container = document.getElementById('topModelsList');
            if (!models || models.length === 0) { container.innerHTML = '<div class="text-gray-400 text-center py-4">Sin datos</div>'; return; }
            container.innerHTML = models.map((model, i) => `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"><div class="flex items-center"><span class="text-2xl mr-3">${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : 'üë§'}</span><div><div class="font-medium">${model.name}</div><div class="text-xs text-gray-500">${model.platform === 'chaturbate' ? 'üü† CB' : 'üî¥ SC'}</div></div></div><div class="font-bold text-purple-600">${model.tokens.toLocaleString()} tk</div></div>`).join('');
        }

        function renderTopFans(fans) {
            const container = document.getElementById('topFansList');
            if (!fans || fans.length === 0) { container.innerHTML = '<div class="text-gray-400 text-center py-4">Sin datos</div>'; return; }
            container.innerHTML = fans.map((fan, i) => `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"><div class="flex items-center"><span class="text-2xl mr-3">${i === 0 ? 'üíé' : i === 1 ? 'üí∞' : 'ü™ô'}</span><div><div class="font-medium">${fan.username || 'An√≥nimo'} ${fan.isNew ? '<span class="text-xs bg-green-100 text-green-700 px-1 rounded">Nuevo</span>' : ''}</div><div class="text-xs text-gray-500">${fan.count} tips ‚Ä¢ Prom: ${fan.avgTip} tk</div></div></div><div class="font-bold text-green-600">${fan.tokens.toLocaleString()} tk</div></div>`).join('');
        }

        function renderTransactions(transactions) {
            const tbody = document.getElementById('transactionsTable');
            if (!transactions || transactions.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-400">Sin transacciones</td></tr>'; return; }
            tbody.innerHTML = transactions.slice(0, 50).map(tx => `<tr class="hover:bg-gray-50"><td class="px-6 py-4 text-sm text-gray-600">${formatDate(tx.transaction_date)}</td><td class="px-6 py-4 text-sm font-medium">${tx.model_name || '-'}</td><td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs font-medium ${tx.platform === 'chaturbate' ? 'bg-orange-100 text-orange-700' : 'bg-red-100 text-red-700'}">${tx.platform === 'chaturbate' ? 'üü† CB' : 'üî¥ SC'}</span></td><td class="px-6 py-4 text-sm text-gray-600">${tx.action_type}</td><td class="px-6 py-4 text-sm text-gray-600">${tx.username || '-'}</td><td class="px-6 py-4 text-sm text-right font-semibold text-purple-600">${tx.tokens} tk</td></tr>`).join('');
        }

        function formatDate(dateStr) { const date = new Date(dateStr); return date.toLocaleDateString('es-CO', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }); }

        function exportCSV() {
            if (!allTransactions || allTransactions.length === 0) { alert('No hay datos para exportar'); return; }
            const headers = ['Fecha', 'Modelo', 'Plataforma', 'Tipo', 'Fan', 'Tokens'];
            const rows = allTransactions.map(tx => [tx.transaction_date, tx.model_name || '', tx.platform, tx.action_type, tx.username || '', tx.tokens]);
            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `analytics_${new Date().toISOString().split('T')[0]}.csv`; a.click();
        }

        loadModels();
        loadAnalytics();

          // Resaltar p√°gina activa en el men√∫
        document.querySelectorAll('aside nav a').forEach(link => {
            if (link.href === window.location.href) {
                link.classList.remove('hover:bg-white/10');
                link.classList.add('bg-white/20');
            }
        });
    </script>
</body>

</html>